<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code</title>
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    body { background: black; color: #FFFF00; font-family: Arial; text-align: center; padding: 40px; margin: 0; }
    .qr-wrapper { background: white; padding: 40px; display: inline-block; border-radius: 20px; margin: 30px 0; }
    #code { font-size: 2em; font-weight: bold; margin: 30px 0; }
    button { padding: 25px 50px; font-size: 2em; background: #FFFF00; color: black; border: none; border-radius: 15px; cursor: pointer; margin: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    button:hover { background: #FFFF99; }
  </style>
</head>
<body>
  <div class="qr-wrapper" id="qrContainer"></div>
  <div id="code"></div>
  <button id="downloadBtn">Download QR to Phone</button>
  <script>
    const SECRET = "TracReader2025!SuperSecretKey#987";

    async function generateHMAC(message) {
      const enc = new TextEncoder();
      const key = await crypto.subtle.importKey("raw", enc.encode(SECRET), { name: "HMAC", hash: "SHA-256" }, false, ["sign"]);
      const sig = await crypto.subtle.sign("HMAC", key, enc.encode(message));
      return Array.from(new Uint8Array(sig)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    const urlParams = new URLSearchParams(window.location.search);
    const gib = urlParams.get('d');

    const machineId = '0243';

    if (!gib) {
      document.getElementById("qrContainer").innerHTML = '';
      document.getElementById('code').textContent = '';
      document.getElementById('downloadBtn').style.display = 'none';
    } else {
      // Extract the first 4 digits after 'cs_test_' (case insensitive)
      const sessionMatch = gib.match(/cs_test_([a-zA-Z0-9]{4})/i);
      if (!sessionMatch) {
        document.getElementById("qrContainer").innerHTML = '';
        document.getElementById('code').textContent = '';
        document.getElementById('downloadBtn').style.display = 'none';
      } else {
        const embedded4 = sessionMatch[1].toUpperCase();

        // Determine plays from fixed prefix/suffix in your gibberish template
        let plays;
        if (gib.startsWith('jdfjrgfofjjcrfhnjrsvhyriu') && gib.endsWith('48473ydfshfrjhffr84948r7c48n989te8cfrhnffrh')) plays = 1; // $1.39
        else if (gib.startsWith('kldffrcunrkjnjk38548449348fjskfhn5rhufsiodjfiae834jeh4') && gib.endsWith('moregibberish999999')) plays = 3; // $3.39
        else if (gib.startsWith('g7h8i9jkl012mno345pqr678stu901vwx234yza567') && gib.endsWith('evenmoregibberish123456')) plays = 5; // $5.39
        else if (gib.startsWith('j0k1l2mno345pqr678stu901vwx234yza567bcd890') && gib.endsWith('finalgibberishabcdef')) plays = 10; // $10.39
        else plays = 0;

        if (plays === 0) {
          document.getElementById("qrContainer").innerHTML = '';
          document.getElementById('code').textContent = '';
          document.getElementById('downloadBtn').style.display = 'none';
        } else {
          // Use the full gib string as seed (includes the embedded 4 digits)
          generateHMAC(gib).then(gibHash => {
            const randomId = gibHash.substring(0, 4).toUpperCase();

            const dataToSign = `${plays}|${machineId}${randomId}`;

            generateHMAC(dataToSign).then(hash => {
              const shortSig = hash.substring(0, 4).toUpperCase();
              const code = plays === 10 ? `10-${machineId}${randomId}${shortSig}` : `${plays}-${machineId}${randomId}${shortSig}`;

              document.getElementById('code').textContent = code;
              document.getElementById("qrContainer").innerHTML = "";
              new QRCode(document.getElementById("qrContainer"), {
                text: code,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#FFFFFF",
                correctLevel: QRCode.CorrectLevel.H
              });

              document.getElementById('downloadBtn').onclick = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 440;
                canvas.height = 520;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                const qrCanvas = document.querySelector('#qrContainer canvas');
                ctx.drawImage(qrCanvas, 40, 40, 360, 360);
                ctx.fillStyle = 'black';
                ctx.font = 'bold 30px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(code, canvas.width / 2, 460);
                const url = canvas.toDataURL('image/png');
                const randomSuffix = Math.random().toString(36).substring(2, 6).toUpperCase();
                const a = document.createElement('a');
                a.href = url;
                a.download = `Trac-QR-${machineId}-${plays}plays-${randomSuffix}.png`;
                a.click();
              };
            });
          });
        }
      }
    }
  </script>
</body>
</html>
